cmake_minimum_required(VERSION 3.14)
project(ServiceControl)

set(CMAKE_INCLUDE_CURRENT_DIR ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)

find_package(Qt5Widgets CONFIG REQUIRED)
find_package(Qt5DBus)
find_package(CapnProto)

set(SERVICECONTROL_SRC
  src/ui/main.cpp
  src/ui/servicecontrol.cpp
)
add_executable(servicecontrol ${SERVICECONTROL_SRC})
target_link_libraries(servicecontrol Qt5::Widgets)
install(TARGETS servicecontrol DESTINATION bin)

set(SYSTEMD_DBUS_XML
# BEGIN DBUS INTERFACE LIST
# autogenerated by update-dbus-interfaces.sh
  src/worker/dbus/org.freedesktop.DBus.xml
  src/worker/dbus/org.freedesktop.hostname1.xml
  src/worker/dbus/org.freedesktop.import1.ImportManager.xml
  # WIP: The following need more manual work.
  #src/worker/dbus/org.freedesktop.import1.Transfer.xml
  #src/worker/dbus/org.freedesktop.locale1.xml
  #src/worker/dbus/org.freedesktop.LogControl1.xml
  #src/worker/dbus/org.freedesktop.login1.LoginManager.xml
  #src/worker/dbus/org.freedesktop.login1.Seat.xml
  #src/worker/dbus/org.freedesktop.login1.Session.xml
  #src/worker/dbus/org.freedesktop.login1.User.xml
  #src/worker/dbus/org.freedesktop.machine1.Image.xml
  #src/worker/dbus/org.freedesktop.machine1.MachineManager.xml
  #src/worker/dbus/org.freedesktop.machine1.Machine.xml
  #src/worker/dbus/org.freedesktop.network1.DHCPServer.xml
  #src/worker/dbus/org.freedesktop.network1.NetworkLink.xml
  #src/worker/dbus/org.freedesktop.network1.NetworkManager.xml
  #src/worker/dbus/org.freedesktop.network1.Network.xml
  #src/worker/dbus/org.freedesktop.oom1.OomManager.xml
  #src/worker/dbus/org.freedesktop.resolve1.DnssdService.xml
  #src/worker/dbus/org.freedesktop.resolve1.ResolveLink.xml
  #src/worker/dbus/org.freedesktop.resolve1.ResolveManager.xml
  #src/worker/dbus/org.freedesktop.systemd1.Automount.xml
  #src/worker/dbus/org.freedesktop.systemd1.Device.xml
  #src/worker/dbus/org.freedesktop.systemd1.Job.xml
  #src/worker/dbus/org.freedesktop.systemd1.Manager.xml
  #src/worker/dbus/org.freedesktop.systemd1.Mount.xml
  #src/worker/dbus/org.freedesktop.systemd1.Path.xml
  #src/worker/dbus/org.freedesktop.systemd1.Scope.xml
  #src/worker/dbus/org.freedesktop.systemd1.Service.xml
  #src/worker/dbus/org.freedesktop.systemd1.Slice.xml
  #src/worker/dbus/org.freedesktop.systemd1.Socket.xml
  #src/worker/dbus/org.freedesktop.systemd1.Swap.xml
  #src/worker/dbus/org.freedesktop.systemd1.Target.xml
  #src/worker/dbus/org.freedesktop.systemd1.Timer.xml
  #src/worker/dbus/org.freedesktop.systemd1.Unit.xml
  #src/worker/dbus/org.freedesktop.timedate1.xml
# END DBUS INTERFACE LIST
)

set_property(SOURCE ${SYSTEMD_DBUS_XML} PROPERTY INCLUDE src/worker/sdtypes.h)
set_source_files_properties(${SYSTEMD_DBUS_XML} PROPERTIES NO_NAMESPACE FALSE)

capnp_generate_cpp(CAPNP_SRCS CAPNP_HDRS src/worker/proto.capnp)
set(SERVICECONTROL_WORKER_SRC
  src/worker/main.cpp
)
qt_add_dbus_interfaces(SERVICECONTROL_WORKER_SRC ${SYSTEMD_DBUS_XML})
add_executable(servicecontrol-worker ${SERVICECONTROL_WORKER_SRC} ${CAPNP_SRCS})
target_link_libraries(servicecontrol-worker PRIVATE Qt5::Core Qt5::DBus CapnProto::capnp-rpc)
target_include_directories(servicecontrol-worker PRIVATE ${CMAKE_CURRENT_BINARY_DIR})
install(TARGETS servicecontrol-worker DESTINATION bin)
